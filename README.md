# start-and-stop-rds

## 前提
RDSの一時停止は最大7日間のため、自動でインスタンスが再起動してしまう。
Lambdaで関数を設定し、6日に1度自動でインスタンスを起動・停止するようにする。

## 設定方法

[参考](https://www.t3a.jp/blog/infrastructure/rds-auto-start-stop/#outline__1)

### IAMでロールの作成

1. IAM > ロール へ移動する
2. 「ロールの作成」をクリック
3. 「信用されたエンティティの種類を選択」で「AWSサービス」を選択
4. 「このロールを使用するサービスを選択」で「Lambda」を選択
5. 「Attach アクセス権限ポリシー」で「CloudWatchFullAccess」「AmazonRDSFullAccess」の2つを選択
6. タグは設定せず、「ロールの作成」をクリック

### Lambdaの設定
startとstopでそれぞれ1~13を行う。

1. Lambda > 関数へ移動する
2. 「関数の作成」をクリック
3. 「一から作成」を選択し、関数名を入力
4. 「ランタイム」で「Python3.9」を選択
5. 「実行ロールの選択または作成」をクリックし「既存のロールを使用する」を選択
6. 先ほど作成したロールを選択する
7. 「関数の作成」をクリック

8. 左メニューにある「トリガーの追加」をクリック
9. 「CloudWatch Events」を選択し、ルール名を入力
10. 「ルールタイプ」で「スケジュール式」を選択
11. startの場合、`cron(00 3 */6 * ? *)` （6日おきの12:00）を登録
12. stopの場合、`cron(30 3 0/6 * ? *)` （6日おきの12:30）を登録
13. 「追加」をクリック

### スクリプト(Python)の作成
startとstopでそれぞれ1~4を行う。

1. 先ほど作成した関数を選択
2. 「コード」に`start_rds.py`または`stop_rds.py`の内容をペースト
3. 変数`instance`と`region`をRDSに合わせて設定
4. 「Deploy」をクリック
